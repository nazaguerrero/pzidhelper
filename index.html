<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PZ B42.13.1 IDhelper</title>
    <style>
        :root {
            --bg: #111; --text: #eee; --accent: #ff6600; --card: #222;
            --btn: #444; --btn-hover: #666; --danger: #900; --success: #006600; --output: #0f0;
        }
        * { box-sizing: border-box; }
        body { font-family: Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 1rem; line-height: 1.5; }
        .container { max-width: 900px; margin: 0 auto; }
        h1 { color: var(--accent); text-align: center; }
        #input-container { position: relative; display: flex; gap: 10px; margin-bottom: 0.75rem; }
        input[type="text"] { flex-grow: 1; padding: 0.75rem; background: var(--card); color: var(--text); border: 1px solid #444; border-radius: 4px; }
        button { padding: 0.75rem 1.25rem; background: var(--btn); color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background: var(--btn-hover); }
        #status { min-height: 1.5rem; color: #ffcc00; margin: 0.5rem 0; font-size: 0.9rem; }
        
        /* Mod Items & Dragging */
        .mod-item { 
            background: var(--card); padding: 0.75rem; margin: 0.5rem 0; border-radius: 6px; 
            display: flex; justify-content: space-between; align-items: center; cursor: grab;
            border: 1px solid #333;
        }
        .mod-item.dragging { opacity: 0.4; border: 2px dashed var(--accent); }
        .mod-item strong { transition: color 0.2s; }
        .mod-item:active strong { color: var(--accent); }

        /* Dropdown */
        .search-results-list { 
            position: absolute; top: 100%; left: 0; width: 100%; z-index: 999; 
            background: #222; border: 1px solid var(--accent); max-height: 250px; overflow-y: auto; 
        }
        .search-item-btn { 
            width: 100%; text-align: left; padding: 10px; background: transparent; 
            color: #ddd; border: none; border-bottom: 1px solid #333; cursor: pointer; 
        }
        .search-item-btn:hover { background: #333; }

        pre { background: #000; color: var(--output); padding: 1rem; border-radius: 6px; overflow-x: auto; white-space: pre; border: 1px solid #333; }
        .manual-add { margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #444; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Project Zomboid ID Helper (B42)</h1>
        
        <div id="input-container">
            <input type="text" id="input" placeholder="Workshop ID, URL, or Mod Name..." />
            <button id="addBtn">Add Mod</button>
        </div>
        <div id="status">Ready.</div>
        <div id="modlist"></div>

        <div class="manual-add">
            <h3>Manual Fallback</h3>
            <div style="display:flex; gap:10px;">
                <input type="text" id="manualWid" placeholder="Workshop ID" style="width:40%"/>
                <input type="text" id="manualName" placeholder="Mod ID" style="width:40%"/>
                <button id="manualAddBtn">Add</button>
            </div>
        </div>

        <div style="margin-top:2rem;">
            <strong>WorkshopItems=</strong>
            <pre id="workshop-line"></pre>
            <button onclick="copyText('workshop-line')" style="background:var(--success)">Copy WorkshopItems</button>
            
            <div style="margin-top:1.5rem;">
                <strong>Mods=</strong>
                <pre id="mods-line"></pre>
                <button onclick="copyText('mods-line')" style="background:var(--success)">Copy Mods</button>
            </div>
        </div>
    </div>

<script>
const PROXY_BASE = 'https://pz-mod-proxy.nazaguerrero.workers.dev';
let mods = [];

// Using Event Listeners instead of onclick="" to avoid "Not Defined" errors
document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('addBtn').addEventListener('click', addMod);
    document.getElementById('manualAddBtn').addEventListener('click', addManual);
    document.getElementById('input').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') addMod();
    });
});

async function addMod() {
    const inputEl = document.getElementById('input');
    const val = inputEl.value.trim();
    if (!val) return;

    const info = await fetchModInfo(val);
    if (info) {
        if (!mods.some(m => m.wid === info.wid)) {
            mods.push(info);
            renderList();
            updateOutput();
            inputEl.value = '';
            inputEl.focus();
        } else {
            document.getElementById('status').textContent = 'Mod already in list.';
        }
    }
}

async function fetchModInfo(input) {
    const status = document.getElementById('status');
    status.textContent = 'Searching...';
    
    // Check if ID or URL
    let wid = /^\d{7,}$/.test(input) ? input : (input.match(/[?&]id=(\d+)/i)?.[1] || null);

    if (!wid) {
        try {
            const params = new URLSearchParams({ appid: '108600', searchtext: input, section: 'readytouseitems', browsesort: 'trend', p: '1' });
            const resp = await fetch(`${PROXY_BASE}/steam-search?${params}`);
            const text = await resp.text();
            const results = [];
            const searchRegex = /sharedfiles\/filedetails\/\?id=(\d+)[^>]*>([\s\S]*?)<\/div>/gi;
            let match;
            while ((match = searchRegex.exec(text)) !== null && results.length < 5) {
                results.push({ wid: match[1], title: match[2].replace(/<[^>]+>/g, '').trim() });
            }
            if (results.length === 0) { status.textContent = 'No results found.'; return null; }
            showModSelection(results, input);
            return null;
        } catch (e) { status.textContent = 'Error searching.'; return null; }
    }
    return await getDetailsOnly(wid);
}

function showModSelection(candidates, searchInput) {
    const existing = document.querySelector('.search-results-list');
    if (existing) existing.remove();

    const list = document.createElement('div');
    list.className = 'search-results-list';

    const header = document.createElement('div');
    header.style.cssText = 'display:flex; justify-content:space-between; align-items:center; padding:8px; background:#333; font-size:0.8rem;';
    header.innerHTML = `<span>Results for "${searchInput}"</span><button id="closeDropdown" style="background:none; border:none; color:white; cursor:pointer;">✕</button>`;
    list.appendChild(header);

    candidates.forEach(cand => {
        const btn = document.createElement('button');
        btn.className = 'search-item-btn';
        btn.innerHTML = `<b>${cand.title}</b><br><small>ID: ${cand.wid}</small>`;
        btn.onclick = async () => {
            const info = await getDetailsOnly(cand.wid);
            if (info) {
                mods.push(info);
                renderList();
                updateOutput();
                document.getElementById('input').value = '';
            }
            list.remove();
        };
        list.appendChild(btn);
    });

    document.getElementById('input-container').appendChild(list);
    document.getElementById('closeDropdown').onclick = () => list.remove();
}

async function getDetailsOnly(wid) {
    try {
        const formData = new FormData();
        formData.append('itemcount', '1');
        formData.append('publishedfileids[0]', wid);
        const resp = await fetch(`${PROXY_BASE}/steam-details`, { method: 'POST', body: formData });
        const json = await resp.json();
        const d = json?.response?.publishedfiledetails?.[0];
        if (!d || d.result !== 1) return null;
        
        let modName = d.description.match(/mod\s*(?:id|ID|i\.?d\.?):\s*([a-zA-Z0-9_\-.]+)/i)?.[1] || d.title.replace(/[^a-zA-Z0-9_\-]/g, '');
        document.getElementById('status').textContent = 'Added: ' + modName;
        return { wid: wid, name: modName };
    } catch (e) { return null; }
}

function renderList() {
    const container = document.getElementById('modlist');
    container.innerHTML = mods.length ? '<div style="display:flex; justify-content:space-between;"><h3>List:</h3><button onclick="clearAll()" style="background:var(--danger); padding:5px 10px; font-size:12px;">Clear All</button></div>' : '';

    mods.forEach((m, i) => {
        const div = document.createElement('div');
        div.className = 'mod-item';
        div.draggable = true;
        div.dataset.index = i;
        div.innerHTML = `<span>☰ <strong>${m.name}</strong> <small>(${m.wid})</small></span><button onclick="removeMod(${i})" style="background:var(--danger); padding:4px 8px;">X</button>`;
        
        div.addEventListener('dragstart', () => div.classList.add('dragging'));
        div.addEventListener('dragend', () => { div.classList.remove('dragging'); syncArrayToDOM(); });
        container.appendChild(div);
    });

    container.addEventListener('dragover', e => {
        e.preventDefault();
        const dragging = document.querySelector('.dragging');
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) container.appendChild(dragging);
        else container.insertBefore(dragging, afterElement);
    });
}

function getDragAfterElement(container, y) {
    const elements = [...container.querySelectorAll('.mod-item:not(.dragging)')];
    return elements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
        else return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

function syncArrayToDOM() {
    const items = [...document.querySelectorAll('.mod-item')];
    mods = items.map(item => mods[item.dataset.index]);
    renderList();
    updateOutput();
}

function removeMod(i) { mods.splice(i, 1); renderList(); updateOutput(); }
function clearAll() { if(confirm("Clear list?")) { mods = []; renderList(); updateOutput(); } }

function addManual() {
    const w = document.getElementById('manualWid').value.trim();
    const n = document.getElementById('manualName').value.trim();
    if(w && n) { mods.push({wid:w, name:n}); renderList(); updateOutput(); }
}

function updateOutput() {
    document.getElementById('workshop-line').textContent = mods.length ? `WorkshopItems=${mods.map(m => m.wid).join(';')}` : '';
    document.getElementById('mods-line').textContent = mods.length ? `Mods=${mods.map(m => '\\' + m.name).join(';')}` : '';
}

function copyText(id) {
    const t = document.getElementById(id).textContent;
    if(t) navigator.clipboard.writeText(t).then(() => alert('Copied!'));
}
</script>
</body>
</html>
