<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>PZ B42 ID Helper</title>
        <style>
            :root {
                --bg: #111;
                --text: #eee;
                --accent: #ff6600;
                --card: #222;
                --btn: #444;
                --btn-hover: #666;
                --success: #008800;
                --output: #0f0;
            }
        
            body {
                font-family: sans-serif;
                background: var(--bg);
                color: var(--text);
                padding: 1rem;
                margin: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                /* This centers the content */
            }
        
            .container {
                width: 100%;
                max-width: 800px;
                margin: 0 auto;
            }
        
            h1 {
                color: var(--accent);
                text-align: center;
                margin: 10px 0 20px 0;
                font-size: 2.2rem;
                text-transform: uppercase;
                letter-spacing: 1px;
            }

        .version-toggle {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            background: #1a1a1a;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #333;
        }

        .v-btn {
            background: #333;
            color: #888;
            border: 1px solid #444;
            padding: 6px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
        }

        .v-btn.active {
            background: var(--accent);
            color: #000;
            border-color: #fff;
        }

        #input-container {
            position: relative;
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            z-index: 100;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px;
            background: var(--card);
            color: #fff;
            border: 1px solid #444;
            border-radius: 4px;
            font-size: 1rem;
        }

        button {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 4px;
            background: var(--btn);
            color: #fff;
            font-size: 1rem;
            transition: background 0.2s;
        }

        button:hover {
            background: var(--btn-hover);
        }

        #status {
            margin-bottom: 15px;
            min-height: 40px;
            font-size: 0.9rem;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #modlist {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #333;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
            position: relative;
            scroll-behavior: smooth;
        }

        #modlist::-webkit-scrollbar {
            width: 8px;
        }

        #modlist::-webkit-scrollbar-track {
            background: #111;
        }

        #modlist::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 4px;
        }

        #modlist::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }

        .list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #444;
            position: sticky;
            top: 0;
            z-index: 10;
            background: #1a1a1a;
        }

        .count-badge {
            background: var(--accent);
            color: #000;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.85rem;
            margin-left: 8px;
        }

        .mod-item {
            background: var(--card);
            padding: 12px;
            margin: 8px;
            border-radius: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            border: 1px solid #333;
            transition: all 0.3s ease;
        }

        .mod-item.dragging {
            opacity: 0.5;
            border: 2px solid var(--accent) !important;
            background: #333;
        }

        .search-highlight {
            border: 2px solid var(--accent) !important;
            box-shadow: 0 0 15px rgba(255, 102, 0, 0.4);
            background: #333 !important;
        }

        .mod-index {
            background: #111;
            color: var(--accent);
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 10px;
            min-width: 28px;
            text-align: center;
            border: 1px solid #444;
        }

        .edit-input {
            background: #000;
            color: var(--output);
            border: 1px solid var(--accent);
            padding: 4px;
            width: 250px;
        }

        .search-results-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #222;
            border: 2px solid var(--accent);
            border-radius: 4px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.9);
            max-height: 400px;
            overflow-y: auto;
            z-index: 10000;
        }

        .search-item-btn {
            width: 100%;
            text-align: left;
            padding: 12px 15px;
            background: #222;
            color: #eee;
            border: none;
            border-bottom: 1px solid #333;
            cursor: pointer;
            display: block;
        }

        .search-item-btn:hover {
            background: #333;
            border-left: 4px solid var(--accent);
        }

        .search-item-btn b {
            color: var(--accent);
            font-size: 1.1rem;
            display: block;
        }

        pre {
            background: #000;
            color: var(--output);
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #333;
            white-space: pre-wrap;
            word-break: break-all;
            font-family: monospace;
        }

        .highlight-text {
            background-color: var(--accent);
            color: #000;
            font-weight: bold;
            border-radius: 2px;
            padding: 0 2px;
        }

        @keyframes flash-success {
            0% {
                background-color: #004400;
            }

            100% {
                background-color: #000000;
            }
        }

        .copy-flash {
            animation: flash-success 0.6s ease-out !important;
        }

        #localFilter {
            width: 100%;
            padding: 10px;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            border-radius: 4px;
            margin-bottom: 10px;
            display: none;
        }

        .warn-box {
            background: #600;
            color: #fff;
            padding: 10px;
            border: 1px solid #f00;
            border-radius: 4px;
            font-size: 0.9rem;
            margin-top: 10px;
            line-height: 1.4;
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            75% {
                transform: translateX(5px);
            }
        }

        .duplicate-error {
            border: 2px solid #ff0000 !important;
            animation: shake 0.4s ease-in-out;
            background: #400 !important;
        }

        .dep-warning {
            display: block !important;
            visibility: visible !important;
            background: #554400 !important;
            color: white !important;
            border: 1px solid orange !important;
            padding: 10px !important;
            z-index: 100;
        }

        .dep-id {
            font-family: monospace;
            background: #000;
            padding: 2px 5px;
            border-radius: 3px;
            color: #00d4ff;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>PZ B42 ID Helper</h1>
        <div class="version-toggle">
            <label style="font-size: 0.9rem; color: #888; font-weight: bold;">OUTPUT FORMAT:</label>
            <button id="v41" class="v-btn">B41 (Legacy)</button>
            <button id="v42" class="v-btn active">B42 (Backslash \)</button>
        </div>
        Â  Â 
        Â  Â  <div id="input-container">
            Â  Â  Â  Â  <input type="text" id="mainInput" placeholder="Workshop ID, URL, or Mod Name..." />
            Â  Â  Â  Â  <button id="addBtn">Add Mod</button>
            Â  Â  </div>
        Â  Â  <div id="status">Ready.</div>

        Â  Â  <input type="text" id="localFilter" placeholder="ğŸ” Find & Highlight a mod in your list..." />
        Â  Â  <div id="modlist"></div>

        Â  Â  <div style="margin-top: 30px;">
            Â  Â  Â  Â  <div style="margin-top: 20px;">
                Â  Â  Â  Â  Â  Â  <strong style="color: var(--accent);">Mods=</strong>
                Â  Â  Â  Â  Â  Â 
                <pre id="outM"></pre>
                Â  Â  Â  Â  Â  Â  <button id="copyM" style="background:var(--success)">ğŸ“‹ Copy Mods Line</button>
                Â  Â  Â  Â 
            </div>

            Â  Â  Â  Â  <div style="margin-top: 20px;">
                Â  Â  Â  Â  Â  Â  <strong style="color: var(--accent);">Map=</strong>
                Â  Â  Â  Â  Â  Â 
                <pre id="outMap"></pre>
                Â  Â  Â  Â  Â  Â  <button id="copyMap" style="background:var(--success)">ğŸ“‹ Copy Map Line</button>
                Â  Â  Â  Â 
            </div>

            Â  Â  Â  Â  <div style="margin-top: 20px;">
                Â  Â  Â  Â  Â  Â  <strong style="color: var(--accent);">WorkshopItems=</strong>
                Â  Â  Â  Â  Â  Â 
                <pre id="outW"></pre>
                Â  Â  Â  Â  Â  Â  <button id="copyW" style="background:var(--success)">ğŸ“‹ Copy WorkshopItems Line</button>
                Â  Â  Â  Â 
            </div>
            Â  Â  </div>
    </div>

    <script>
       (function () {
            const PROXY = 'https://corsproxy.io/?url=https://api.steampowered.com/ISteamRemoteStorage/GetPublishedFileDetails/v1/';
            let mods = [];
            let isB42 = true;
            let draggingWID = null;

            document.addEventListener('DOMContentLoaded', () => {
                loadFromDisk();
                document.getElementById('v41').onclick = () => { isB42 = false; updateToggleUI(); };
                document.getElementById('v42').onclick = () => { isB42 = true; updateToggleUI(); };
                document.getElementById('addBtn').onclick = handleAdd;
                document.getElementById('mainInput').onkeydown = (e) => { if (e.key === 'Enter') handleAdd(); };

                document.getElementById('copyW').onclick = () => copyText('outW');
                document.getElementById('copyM').onclick = () => copyText('outM');
                document.getElementById('copyMap').onclick = () => copyText('outMap');

                document.getElementById('localFilter').oninput = (e) => {
                    const term = e.target.value.toLowerCase();
                    const items = document.querySelectorAll('.mod-item');
                    items.forEach(item => item.classList.remove('search-highlight'));
                    if (term.length < 2) return;
                    for (const item of items) {
                        if (item.innerText.toLowerCase().includes(term)) {
                            item.classList.add('search-highlight');
                            item.scrollIntoView({ behavior: 'smooth', block: 'center' });
                            break;
                        }
                    }
                };

                document.addEventListener('click', (e) => {
                    const list = document.querySelector('.search-results-list');
                    const inputCont = document.getElementById('input-container');
                    if (list && !inputCont.contains(e.target)) list.remove();
                });

                render();
            });

            function updateToggleUI() {
                document.getElementById('v41').classList.toggle('active', !isB42);
                document.getElementById('v42').classList.toggle('active', isB42);
                updateOut();
            }

            function saveToDisk() { localStorage.setItem('pz_helper_pro_v3', JSON.stringify(mods)); }
            function loadFromDisk() {
                const saved = localStorage.getItem('pz_helper_pro_v3');
                if (saved) { try { mods = JSON.parse(saved); } catch (e) { mods = []; } }
            }

            async function handleAdd() {
                const input = document.getElementById('mainInput');
                const val = input.value.trim();
                if (!val) return;
                const info = await fetchInfo(val);
                if (info) {
                    addModToList(info);
                    input.value = '';
                }
            }

            async function fetchInfo(val) {
                const status = document.getElementById('status');
                status.innerHTML = "Searching Steam...";
                let wid = /^\d{7,}$/.test(val) ? val : (val.match(/[?&]id=(\d+)/i)?.[1] || null);

                if (!wid) {
                    try {
                        const p = new URLSearchParams({ appid: '108600', searchtext: val, section: 'readytouseitems', browsesort: 'trend', p: '1' });
                        const r = await fetch(`${PROXY}/steam-search?${p}`);
                        const t = await r.text();
                        const results = [];
                        const searchRegex = /sharedfiles\/filedetails\/\?id=(\d+)[\s\S]*?workshopItemTitle[^>]*>([\s\S]*?)<\/div>/gi;
                        let m;
                        while ((m = searchRegex.exec(t)) !== null && results.length < 5) {
                            results.push({ wid: m[1], title: m[2].replace(/<[^>]+>/g, '').replace(/ID:|Learn More/gi, '').trim() });
                        }
                        if (results.length === 0) { status.textContent = "No results found."; return null; }
                        showResults(results);
                        return null;
                    } catch (e) { status.textContent = "Search failed."; return null; }
                }
                return await getDetails(wid, true);
            }

            async function getDetails(id, isDirect = false) {
               try {
                   const status = document.getElementById('status');
                   // This is a more stable public proxy bridge
                   const proxyUrl = 'https://corsproxy.io/?url=https://api.steampowered.com/ISteamRemoteStorage/GetPublishedFileDetails/v1/';

                   const params = new URLSearchParams();
                   params.append('itemcount', '1');
                   params.append('publishedfileids[0]', id);
                   params.append('includerelations', '1');

                   const r = await fetch(proxyUrl, {
                       method: 'POST',
                       body: params,
                       headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
                   });

                   if (!r.ok) throw new Error("Steam API unreachable");

                   const j = await r.json();
                   const d = j?.response?.publishedfiledetails?.[0];

                   if (!d || d.result !== 1) {
                       status.textContent = "Mod not found on Steam.";
                       return null;
                   }

                   const description = d.description || "";
                   const title = d.title || "";

                   // Get dependencies (Sidebar + Text)
                   let deps = [];
                   if (d.children) {
                       deps = d.children.map(c => String(c.publishedfileid));
                   }

                   // Search text for "Workshop ID" but block Bikini Tools (2634426926)
                   const workshopMatches = [...description.matchAll(/workshop\s*id\s*[:\s-]+\s*(\d+)/gi)];
                   workshopMatches.forEach(m => {
                       const foundId = String(m[1]);
                       if (foundId !== id && foundId !== '2634426926') {
                           deps.push(foundId);
                       }
                   });

                   // Get the Mod ID (e.g., "Ranger91")
                   const modIdMatches = [...description.matchAll(/mod\s*id\s*:\s*([a-zA-Z0-9_\-.\s]+)/gi)];
                   let validIDs = [];
                   modIdMatches.forEach(m => {
                       const idText = m[1].split('\n')[0].trim();
                       if (idText.length > 0) validIDs.push(idText);
                   });

                   const finalModID = validIDs.length > 0 ? validIDs.join(';') : title.replace(/[^a-zA-Z0-9_\-]/g, '');

                   status.innerHTML = `<span style="color:#00ff00">âœ… Found: ${title}</span>`;

                   return {
                       wid: id,
                       name: finalModID,
                       isMap: /map|muldraugh|location|cell/i.test(description + title),
                       title: title,
                       needs: [...new Set(deps)]
                   };

               } catch (e) {
                   console.error("Fetch error:", e);
                   document.getElementById('status').textContent = "Proxy Error. Try again in a moment.";
                   return null;
               }
           }

            function showResults(data) {
                const container = document.getElementById('input-container');
                const old = document.querySelector('.search-results-list');
                if (old) old.remove();
                const list = document.createElement('div');
                list.className = 'search-results-list';
                list.innerHTML = `<div style="padding:10px; background:#111; border-bottom:1px solid #444; display:flex; justify-content:space-between; align-items:center;"><span style="font-size:12px; font-weight:bold; color:#888;">SEARCH RESULTS</span><button type="button" onclick="this.closest('.search-results-list').remove()" style="background:none; border:none; color:#f44; cursor:pointer; font-weight:bold; font-size:16px;">âœ•</button></div>`;
                data.forEach(item => {
                    const b = document.createElement('button');
                    b.className = 'search-item-btn';
                    b.innerHTML = `<b>${item.title}</b><small>Workshop ID: ${item.wid}</small>`;
                    b.onclick = async (e) => {
                        e.stopPropagation(); list.remove(); document.getElementById('mainInput').value = '';
                        const details = await getDetails(item.wid, false);
                        if (details) addModToList(details);
                    };
                    list.appendChild(b);
                });
                container.appendChild(list);
            }

            function addModToList(obj) {
                const status = document.getElementById('status');
                const existingIndex = mods.findIndex(m => String(m.wid) === String(obj.wid));

                if (existingIndex !== -1) {
                    status.innerHTML = `<div style="background:#600; color:white; padding:8px; border:1px solid red; border-radius:4px;">âš ï¸ DUPLICATE: Already at position #${existingIndex + 1}</div>`;
                    const items = document.querySelectorAll('.mod-item');
                    const duplicateItem = items[existingIndex];
                    if (duplicateItem) {
                        duplicateItem.classList.add('duplicate-error');
                        duplicateItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        setTimeout(() => duplicateItem.classList.remove('duplicate-error'), 2000);
                    }
                    return;
                }

                mods.push(obj);
                render();
                saveToDisk();
            }

            function render() {
                const list = document.getElementById('modlist');
                const filter = document.getElementById('localFilter');
                list.innerHTML = '';

                if (mods.length === 0) {
                    list.innerHTML = `<div style="text-align:center; padding:20px; color:#666; border:2px dashed #333; border-radius:6px; margin:10px;">No mods added yet.</div>`;
                    filter.style.display = 'none';
                    updateOut();
                    return;
                }

                filter.style.display = mods.length > 5 ? 'block' : 'none';

                const header = document.createElement('div');
                header.className = 'list-header';
                header.innerHTML = `
            <div><h3 style="display:inline; margin:0;">Added Mods</h3><span class="count-badge">${mods.length}</span></div>
            <div style="display:flex; gap:8px;">
                <button id="jumpTop" style="background:#222; border:1px solid #444; font-size:11px; padding:5px 8px; color:#fff;">â†‘ Top</button>
                <button id="jumpBottom" style="background:#222; border:1px solid #444; font-size:11px; padding:5px 8px; color:#fff;">â†“ End</button>
                <button id="clrBtn" style="background:#900; padding:5px 10px; font-size:12px; color:white; border:none; border-radius:4px; cursor:pointer;">Clear All</button>
            </div>`;
                list.appendChild(header);

                document.getElementById('jumpTop').onclick = () => list.scrollTo({ top: 0, behavior: 'smooth' });
                document.getElementById('jumpBottom').onclick = () => list.scrollTo({ top: list.scrollHeight, behavior: 'smooth' });
                document.getElementById('clrBtn').onclick = () => { if (confirm("Clear everything?")) { mods = []; saveToDisk(); render(); } };

                mods.forEach((m, i) => {
                    const d = document.createElement('div');
                    d.className = 'mod-item';
                    d.draggable = true;
                    d.dataset.wid = m.wid;
                    d.innerHTML = `
                <span>
                    <span class="mod-index">${i + 1}</span>
                    <b class="mod-id-label">${m.name}</b> 
                    <small style="color:#888;">(${m.wid})</small>
                </span>
                <div style="display:flex; gap:8px; align-items:center;">
                    <label style="font-size:10px; color:#888;">Map?</label>
                    <input type="checkbox" class="map-check" ${m.isMap ? 'checked' : ''}>
                    <button type="button" class="edit-btn" style="background:#444; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">âœ</button>
                    <button type="button" class="rmv-btn" style="background:#900; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">X</button>
                </div>`;

                    d.querySelector('.map-check').onchange = (e) => { m.isMap = e.target.checked; saveToDisk(); updateOut(); };
                    d.querySelector('.edit-btn').onclick = (e) => {
                        e.stopPropagation();
                        const label = d.querySelector('.mod-id-label');
                        const input = document.createElement('input');
                        input.className = 'edit-input';
                        input.value = m.name;
                        input.onblur = () => { m.name = input.value.trim(); saveToDisk(); render(); };
                        input.onkeydown = (ev) => { if (ev.key === 'Enter') input.blur(); };
                        label.replaceWith(input);
                        input.focus();
                    };
                    d.querySelector('.rmv-btn').onclick = (e) => { e.stopPropagation(); mods.splice(i, 1); saveToDisk(); render(); };
                    d.ondragstart = () => { d.classList.add('dragging'); draggingWID = m.wid; };
                    d.ondragend = () => { d.classList.remove('dragging'); draggingWID = null; updateOut(); };

                    // Improved Dependency UI
                    if (m.needs && m.needs.length > 0) {
                        const missing = m.needs.filter(needId => !mods.some(existing => String(existing.wid) === String(needId)));
                        if (missing.length > 0) {
                            const warnDiv = document.createElement('div');
                            warnDiv.className = 'dep-warning';
                            warnDiv.style.width = "100%";
                            warnDiv.style.marginTop = "10px";

                            // Create the header text
                            warnDiv.innerHTML = `âš ï¸ <b>Required Mods:</b> <small>(Click ID to add automatically)</small><br>`;

                            // Create buttons for each missing ID
                            missing.forEach(id => {
                                const btn = document.createElement('button');
                                btn.textContent = id;
                                btn.className = 'dep-id'; // Uses your existing blue styling
                                btn.style.margin = "4px 4px 0 0";
                                btn.style.cursor = "pointer";
                                btn.style.border = "1px solid #00d4ff";

                                btn.onclick = (e) => {
                                    e.preventDefault();
                                    const input = document.getElementById('mainInput');
                                    input.value = id;
                                    document.getElementById('addBtn').click();
                                };
                                warnDiv.appendChild(btn);
                            });

                            d.style.flexWrap = "wrap";
                            d.appendChild(warnDiv);
                        }
                    }
                    list.appendChild(d);
                });
                updateOut();
            }

            function updateOut() {
                const outW = document.getElementById('outW');
                const outM = document.getElementById('outM');
                const outMap = document.getElementById('outMap');
                if (!mods.length) {
                    outW.innerHTML = ''; outM.innerHTML = ''; outMap.innerHTML = 'Muldraugh, KY';
                    return;
                }
                const wStr = mods.map(m => (String(m.wid) === String(draggingWID)) ? `<span class="highlight-text">${m.wid}</span>` : m.wid).join(';');
                const mStr = mods.map(m => {
                    const names = m.name.split(';').map(s => isB42 ? `\\${s.trim()}` : s.trim()).join(';');
                    return (String(m.wid) === String(draggingWID)) ? `<span class="highlight-text">${names}</span>` : names;
                }).join(';');
                const mapMods = mods.filter(m => m.isMap).map(m => m.name.split(';')[0].trim());
                mapMods.push("Muldraugh, KY");
                outW.innerHTML = wStr;
                outM.innerHTML = mStr;
                outMap.innerHTML = mapMods.join(';');
            }

            function copyText(id) {
                const el = document.getElementById(id);
                navigator.clipboard.writeText(el.textContent).then(() => {
                    el.classList.add('copy-flash');
                    setTimeout(() => el.classList.remove('copy-flash'), 600);
                });
            }

            document.getElementById('modlist').addEventListener('dragover', e => {
                e.preventDefault();
                const dragging = document.querySelector('.dragging');
                if (!dragging) return;
                const list = document.getElementById('modlist');
                const afterElement = getDragAfterElement(list, e.clientY);
                if (afterElement == null) list.appendChild(dragging);
                else list.insertBefore(dragging, afterElement);

                const currentItems = [...document.querySelectorAll('.mod-item')];
                mods = currentItems.map(item => mods.find(m => String(m.wid) === String(item.dataset.wid)));
                currentItems.forEach((item, idx) => { item.querySelector('.mod-index').textContent = idx + 1; });
                saveToDisk();
                updateOut();
            });

            function getDragAfterElement(container, y) {
                const draggables = [...container.querySelectorAll('.mod-item:not(.dragging)')];
                return draggables.reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    return (offset < 0 && offset > closest.offset) ? { offset, element: child } : closest;
                }, { offset: Number.NEGATIVE_INFINITY }).element;
            }
        })(); 
    </script>
</body>

</html>